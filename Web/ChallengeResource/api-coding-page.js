var vm=null;var cometd=$.cometd;$("document").ready(function(){$("#modal-loading").modal({keyboard:false});initConn();vm=avalon.define({$id:"codingModel",connected:false,connId:"",projectInfo:{pid:"",pname:"",chineseName:"",ptype:"",ptypeName:"",target:"",totalTime:0,countDown:0,order:"",projectCount:1,code:"",previewfileExist:false},projectRuntime:{compileSwitch:true,compileSwitchCountdown:3,intervalCompile:null,timeoutCompile:false,isSub:0},projectOrder:1,projectCount:1,intervalCountdown:null,modalInfo:{modalTitle:"",modalContent:"",modalBtn:""},firstName:"司徒",lastName:"正美",fullName:{set:function(a){var b=(a||"").split(" ");this.firstName=b[0]||"";this.lastName=b[1]||""},get:function(){return this.firstName+" "+this.lastName}}});avalon.scan();$(function(){$.ajaxSetup({type:"POST",error:function(a,c,b){switch(a.status){case (500):console.log("服务器系统内部错误");break;case (401):console.log("未登录");break;case (403):console.log("无权限执行此操作");break;case (408):console.log("请求超时");break;default:console.log("连接失败，请检查网络。")}},success:function(a){}})});$.ajax({async:true,type:"post",dataType:"json",url:"codingInfo",data:{"reid":$("#input-reid").val(),"order":vm.projectOrder,"user_token":$("#input-userToken").val(),"corp_token":$("#input-corpToken").val()},success:function(a){vm.projectInfo=a;console.log("调试信息：倒计时（请求刚完成时）"+vm.projectInfo.countDown);editor.setValue(a.code);recoveryAll();initStatistics();countDown();initEditor(a.ptype);hideModal("#modal-loading")},error:function(a){console.log(a)}});vm.$watch("projectOrder",function(b,a){if(vm.projectOrder>=0&&vm.projectOrder<=vm.projectInfo.projectCount){$.ajax({async:true,type:"post",dataType:"json",url:"codingInfo",data:{"reid":$("#input-reid").val(),"user_token":$("#input-userToken").val(),"corp_token":$("#input-corpToken").val(),"order":b},success:function(c){vm.projectInfo=c;editor.setValue(c.code);avalon.log("调试信息：项目的总编译时间为"+vm.projectInfo.totalTime+"秒");recoveryAll();initStatistics()},error:function(c,e,d){console.log(c.status);console.log(c.readyState);console.log(e);alert("与服务器连接出现错误："+e+"！请确保网络状况良好并刷新页面。")}})}});vm.projectRuntime.$watch("timeoutCompile",function(b,a){if(b){if(vm.projectRuntime.isSub==0){clearInterval(intervalCompile);hideModal("#waiting");$("#modal-timeout").modal({keyboard:false});vm.projectRuntime.timeoutCompile=false}else{hideModal("#waiting-auto");if(vm.projectOrder<vm.projectInfo.projectCount){vm.modalInfo={modalTitle:"",modalContent:"正在载入下一题。请稍候......",modalBtn:""}}else{vm.modalInfo={modalTitle:"",modalContent:"所有题目都已完成，正在跳转到结果页面。",modalBtn:""}}$("#modal-complete").modal({keyboard:false});setTimeout(function(){hideModal("#modal-complete")},2000);vm.projectOrder++}}});vm.projectRuntime.$watch("compileSwitchCountdown",function(b,a){if(b>0){$("#btn-stop-compile").attr("disabled",true)}else{$("#btn-stop-compile").attr("disabled",false)}});$("#btn-run").click(function(){compile(0)});$("#btn-submit").click(function(){console.log(1);$("#modal-confirm").modal({keyboard:false,backdrop:"static",show:true})});setSize(LOG_SIZE_CONSTANT.initial);$(window).resize(function(){setSize(LOG_SIZE_CONSTANT.initial)});$("#div-maxsize").click(function(){setSize(LOG_SIZE_CONSTANT.maxsize)});$("#div-minisize").click(function(){setSize(LOG_SIZE_CONSTANT.minisize)});$("#btn-stop-compile").click(function(){hideModal("#waiting");clearInterval(intervalCompile)})});function countDown(){clearInterval(intervalCountdown);if(vm.projectInfo.countDown>0){intervalCountdown=setInterval(function(){vm.projectInfo.countDown--;if(vm.projectInfo.countDown<=10){$("#count-down").css("color","red")}if(vm.projectInfo.countDown<=0){compile(1);vm.projectInfo.countDown==0;clearInterval(intervalCountdown)}},1000)}else{if(vm.projectInfo.countDown<=0){compile(1);vm.projectInfo.countDown=0}}}function compile(a){c=editor.getValue();if(c==null||c.trim()==""||c.trim().length==0){$("#modal-timeout").modal({keyboard:false});return}vm.projectRuntime.isSub=a;if(a==3){vm.projectRuntime.isSub=1}var b=(new Date()).getTime();setSize(LOG_SIZE_CONSTANT.minisize);$(".text-log").text("");vm.modalInfo={modalTitle:"编译中，请稍候...",modalContent:"",modalBtn:"停止编译"};console.log("调试信息：开始编译时，项目order是"+vm.projectOrder);var d=1;if(vm.projectRuntime.isSub==0){$("#waiting").modal({keyboard:false,backdrop:"static",show:true});console.log("这是");countdownCompile()}else{$("#waiting-auto").modal({keyboard:false,backdrop:"static",show:true})}if(vm.connected){var c=editor.getValue()+"";console.log("代码为"+c);cometd.publish("/service/hello",{status:"online","pid":vm.projectInfo.pid,"code":editor.getValue(),"connId":vm.connId,"remoteClientId":$("#input-remoteClientId").val(),"reid":$("#input-reid").val(),"isSub":a,"order":vm.projectOrder,"thinkTime":thinkTime,"speed":speed,"costTime":(new Date()).getTime()-thinkTimeStart,"user_token":$("#input-userToken").val(),"corp_token":$("#input-corpToken").val()},function(e){if(e.successful){console.log(e)}else{console.log(e.data);console.log("与服务器连接出现错误："+textStatus+"！请确保网络状况良好并刷新页面。");hideModal("#waiting");
hideModal("#waiting-auto");clearInterval(intervalCompile)}})}else{console.log("未连接")}}function countdownCompile(){vm.projectRuntime.compileSwitchCountdown=3;intervalCompileCountdown=setInterval(function(){vm.projectRuntime.compileSwitchCountdown--;if(vm.projectRuntime.compileSwitchCountdown<=0){clearInterval(intervalCompileCountdown)}},1000)}function recoveryAll(){$("#count-down").css("color","black");thinkTime=0;speed=0;isSpeedStart=true;startStr;endLength;thinkTimeStart=(new Date()).getTime();console.log("调试信息：开始时间重置");thinkTimeEnd=0;firstInput=true;vm.projectRuntime.timeoutCompile=false;vm.projectRuntime.isSub=0;clearInterval(intervalCountdown);countDown()}function hideModal(a){$(a).modal("hide");$(".modal-backdrop").hide()}function initEditor(c){var a=ace.require("ace/ext/language_tools");var b=ace.edit("editor");b.setTheme("ace/theme/idle_fingers");switch(c){case 1:b.getSession().setMode("ace/mode/java");console.log("切换到java");break;case 2:b.getSession().setMode("ace/mode/java");console.log("切换到android");break;case 3:b.getSession().setMode("ace/mode/objectivec");console.log("切换到oc");break;case 4:b.getSession().setMode("ace/mode/c_cpp");console.log("切换到c");break;case 5:b.getSession().setMode("ace/mode/c_cpp");console.log("切换到c++");break;case 6:b.getSession().setMode("ace/mode/php");console.log("切换到php");break;case 7:b.getSession().setMode("ace/mode/python");console.log("切换到python");break;case 8:b.getSession().setMode("ace/mode/ruby");console.log("切换到ruby");break;case 301:b.getSession().setMode("ace/mode/objectivec");console.log("切换到oc");break;default:break}b.setOptions({enableBasicAutocompletion:true,enableLiveAutocompletion:true})}function initConn(){function b(){console.log("CometD Connection Established")}function e(){console.log("CometD Connection Broken")}function a(){console.log("CometD Connection Closed")}function d(h){if(cometd.isDisconnected()){vm.connected=false;a();return}var g=vm.connected;vm.connected=h.successful===true;if(!g&&vm.connected){b()}else{if(g&&!vm.connected){e()}}}function c(g){if(g.successful===true){cometd.batch(function(){cometd.subscribe("/service/returna",function(h){console.log(h.data);console.log("返回成功"+h.data.statusCode+h.data.runinfo+h.data.order);if(h.data.statusCode==COMPILE_INFO.error||h.data.statusCode==COMPILE_INFO.success){console.log("调试信息：编译完成");if(vm.projectRuntime.isSub==0){if(h.data.statusCode==COMPILE_INFO.error){$(".text-log").css("color","black")}else{$(".text-log").css("color","black")}$(".text-log").text(h.data.runinfo);setSize(LOG_SIZE_CONSTANT.maxsize)}else{if(vm.projectRuntime.isSub==1){$(".text-log").text("")}else{console.log("调试信息：isSub错误")}}hideModal("#waiting");hideModal("#waiting-auto");if(1==vm.projectRuntime.isSub&&h.data.order>vm.projectOrder){if(vm.projectOrder<vm.projectInfo.projectCount){vm.modalInfo={modalTitle:"",modalContent:"正在载入下一题。请稍候......",modalBtn:""}}else{vm.modalInfo={modalTitle:"",modalContent:"所有题目都已完成，正在跳转到结果页面。",modalBtn:""}}$("#modal-complete").modal({keyboard:false});setTimeout(function(){hideModal("#modal-complete")},2000);if(vm.projectOrder<vm.projectInfo.projectCount){console.log("调试信息projectOrder增加了");vm.projectOrder++;console.log("调试信息：编译完成后，项目order为"+vm.projectOrder)}else{console.log("调试信息：正在跳转到结果页面。")}}}else{if(h.data.statusCode==COMPILE_INFO.timeout){console.log("编译超时");vm.projectRuntime.timeoutCompile=true}else{if(h.data.statusCode==COMPILE_INFO.codeError){hideModal("#waiting");hideModal("#waiting-auto");vm.modalInfo={modalTitle:"代码错误",modalContent:"代码错误，请检查程序逻辑。",modalBtn:""};$("#modal-notice").modal({keyboard:false})}}}},function(h){if(h.successful){console.log("接受成功")}else{console.log("接受失败")}});$("#btn-confirm-submit").click(function(){compile(1)});$("#btn-recommand").click(function(){compile(3)})});vm.connId=g.clientId}else{console.error("连接出错")}}$(window).unload(function(){cometd.disconnect(true)});var f=$("#input-compile-url").val()+"/cometd";cometd.configure({url:f,logLevel:"error"});cometd.addListener("/meta/handshake",c);cometd.addListener("/meta/connect",d);cometd.handshake()};